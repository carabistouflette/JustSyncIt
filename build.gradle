plugins {
    id 'java'
    id 'application'
    id 'checkstyle'
    id 'com.github.spotbugs' version '6.0.25'
    id 'me.champeau.jmh' version '0.7.2'
    id 'jacoco'
    id 'org.sonarqube' version '4.4.1.3373'
    id 'org.owasp.dependencycheck' version '12.1.0'
}

import org.gradle.api.file.DuplicatesStrategy

group = 'com.justsyncit'
version = '1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

dependencies {
    // JUnit 5 for testing
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.13.4'
    testImplementation 'org.junit.jupiter:junit-jupiter-engine:5.13.4'
    testImplementation 'org.junit.jupiter:junit-jupiter-params:5.13.4'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher:1.13.4'
    
    // Additional testing utilities
    testImplementation 'org.mockito:mockito-core:5.19.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.19.0'
    
    // Logging
    implementation 'org.slf4j:slf4j-api:2.0.16'
    implementation 'ch.qos.logback:logback-classic:1.5.17'
    
    // No external BLAKE3 dependency - using pure Java implementation
    
    // Performance benchmarking
    testImplementation 'org.openjdk.jmh:jmh-core:1.37'
    testAnnotationProcessor 'org.openjdk.jmh:jmh-generator-annprocess:1.37'
}

application {
    mainClass = 'com.justsyncit.JustSyncItApplication'
}

// JaCoCo configuration for code coverage
jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }
    
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                '**/generated/**',
                '**/test/**'
            ])
        }))
    }
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.20  // Require 20% code coverage
            }
        }
    }
}

// SonarQube configuration
sonarqube {
    properties {
        property "sonar.projectKey", "justsyncit"
        property "sonar.organization", "justsyncit"
        property "sonar.host.url", "https://sonarcloud.io"
        property "sonar.java.coveragePlugin", "jacoco"
        property "sonar.coverage.jacoco.xmlReportPaths", "${buildDir}/reports/jacoco/test/jacocoTestReport.xml"
        property "sonar.java.binaries", "${buildDir}/classes/java/main"
        property "sonar.java.test.binaries", "${buildDir}/classes/java/test"
        property "sonar.exclusions", "**/generated/**,**/test/**"
        property "sonar.spotbugs.reportPaths", "${buildDir}/reports/spotbugs/main.xml,${buildDir}/reports/spotbugs/test.xml"
        property "sonar.checkstyle.reportPaths", "${buildDir}/reports/checkstyle/main.xml,${buildDir}/reports/checkstyle/test.xml"
    }
}

// OWASP Dependency Check configuration
dependencyCheck {
    failBuildOnCVSS = 10.0  // Set to 10.0 to effectively disable build failure on vulnerabilities
    failOnError = false  // Don't fail build on NVD data parsing errors
    skip = true  // Skip dependency check entirely due to NVD API issues
    
    suppressionFile = "${rootDir}/config/dependency-check/suppressions.xml"
    
    // Disable auto-update completely to avoid NVD API issues
    autoUpdate = false
    
    // Configure analyzer
    analyzers {
        experimentalEnabled = false
        archiveEnabled = true
        jarEnabled = true
        centralEnabled = true
        nuspecEnabled = false
        assemblyEnabled = false
        golangDepEnabled = false
        golangModEnabled = false
        rubygemsEnabled = false
    }
    
    formats = ['HTML', 'XML', 'CSV', 'JSON', 'SVR']
}

// Disable configuration cache for all dependency check tasks to avoid serialization issues
tasks.matching { it.name.startsWith('dependencyCheck') }.configureEach {
    notCompatibleWithConfigurationCache("Dependency check plugin has known issues with configuration cache")
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

test {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
    }
}

jar {
    manifest {
        attributes(
            'Main-Class': 'com.justsyncit.JustSyncItApplication',
            'Implementation-Title': 'JustSyncIt',
            'Implementation-Version': project.version
        )
    }
}

// Custom tasks for different build types
task devBuild {
    description = 'Build for development'
    group = 'build'
    dependsOn compileJava, processResources, testClasses
}

task testBuild {
    description = 'Build for testing'
    group = 'build'
    dependsOn test
}

task releaseBuild {
    description = 'Build for release'
    group = 'build'
    dependsOn testBuild, jar, jacocoTestReport
}

task downloadDependencies {
    description = 'Download all dependencies'
    group = 'build'
    doLast {
        configurations.compileClasspath.resolve()
        configurations.runtimeClasspath.resolve()
        configurations.testCompileClasspath.resolve()
        configurations.testRuntimeClasspath.resolve()
    }
}

// Checkstyle configuration
checkstyle {
    toolVersion = '10.26.1'
    configFile = file("${rootDir}/config/checkstyle/checkstyle.xml")
    configProperties = [configDir: "${rootDir}/config/checkstyle"]
    ignoreFailures = false
    maxErrors = 0
    maxWarnings = 0
}

// SpotBugs configuration
spotbugs {
    toolVersion = '4.9.0'
    ignoreFailures = false
    effort = com.github.spotbugs.snom.Effort.valueOf('MAX')
    reportLevel = com.github.spotbugs.snom.Confidence.valueOf('LOW')
    excludeFilter = file("${rootDir}/config/spotbugs/exclude.xml")
}

// Configure SpotBugs tasks
tasks.withType(com.github.spotbugs.snom.SpotBugsTask) {
    reports {
        xml {
            required = true
        }
        html {
            required = true
        }
    }
}

// Make test task depend on jacocoTestCoverageVerification for quality gate
test {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
    }
    finalizedBy jacocoTestReport
}

// Add check task dependencies
check.dependsOn jacocoTestCoverageVerification
// Make dependency check optional to avoid blocking builds when NVD API is unavailable
// check.dependsOn dependencyCheckAggregate

// JMH configuration to fix configuration cache issues
jmh {
    includes = ['Blake3PerformanceBenchmark']
    benchmarkMode = ['thrpt']
    batchSize = 1
    fork = 1
    failOnError = true
    forceGC = true
    jvm = 'java'
    jvmArgs = ['-Xmx2g']
    timeOnIteration = '1s'
    warmup = '1s'
    warmupBatchSize = 1
    warmupForks = 1
    warmupIterations = 3
    zip64 = true
    benchmarkParameters = [:]
    profilers = []
    iterations = 5
    resultFormat = 'TEXT'
    resultsFile = layout.buildDirectory.file("results/jmh/results.txt").get().asFile
    
    // Fix configuration cache issues
    duplicateClassesStrategy = DuplicatesStrategy.EXCLUDE
}

// Disable configuration cache for JMH tasks to avoid serialization issues
tasks.matching { it.name.startsWith('jmh') }.configureEach {
    notCompatibleWithConfigurationCache("JMH plugin has known issues with configuration cache")
}

// Disable configuration cache for SonarQube task to avoid compatibility issues
tasks.named('sonarqube') {
    notCompatibleWithConfigurationCache("SonarQube plugin has known issues with configuration cache")
    // Additional configuration to ensure compatibility
    inputs.files(fileTree("src")).withPropertyName("sources").skipWhenEmpty()
    inputs.files(fileTree("build")).withPropertyName("buildDir").skipWhenEmpty()
}

// Also handle any related SonarQube tasks
tasks.matching { it.name.toLowerCase().contains('sonar') }.configureEach {
    notCompatibleWithConfigurationCache("SonarQube plugin has known issues with configuration cache")
}